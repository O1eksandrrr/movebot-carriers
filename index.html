<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –ø–µ—Ä–µ–≤—ñ–∑–Ω–∏–∫–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 14px;
      font-family: 'Inter', sans-serif;
      background-color: #F5F7FA;
      color: #2C3E50;
    }
    h2 {
      color: #007AFF;
      margin-bottom: 24px;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .block {
      padding-bottom: 20px;
      border-bottom: 1px solid #E0E0E0;
    }
    label {
      font-weight: 500;
      margin-bottom: 6px;
      display: block;
    }
    input, textarea, select {
      padding: 12px;
      font-size: 15px;
      border: 1px solid #CCD1D9;
      border-radius: 8px;
      background-color: #fff;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 20px;
    }
    .row {
      display: flex;
      gap: 10px;
    }
    .row > div {
      flex: 1;
    }
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 12px;
    }
    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background-color: #ffffff;
      border: 1px solid #CCD1D9;
      border-radius: 8px;
      font-weight: 500;
      font-size: 15px;
      user-select: none;
      transition: background 0.2s;
    }
    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #007AFF;
    }
    button {
      padding: 14px;
      background-color: #007AFF;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
    }
    input.valid {
      border: 2px solid #2ecc71 !important;
    }
    input.invalid {
      border: 2px solid #e74c3c !important;
    }
  </style>
</head>
<body>
  <h2>üöö –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –ø–µ—Ä–µ–≤—ñ–∑–Ω–∏–∫–∞</h2>
  <form id="driverForm">
    <div class="block">
      <h3>üöõ –î–∞–Ω—ñ –∞–≤—Ç–æ</h3>
      <label>–ú–∞—Ä–∫–∞</label>
      <input type="text" id="brand" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, Mercedes" required />
      <label>–ú–æ–¥–µ–ª—å</label>
      <input type="text" id="model" placeholder="Sprinter" required />
      <label>–ù–æ–º–µ—Ä–Ω–∏–π –∑–Ω–∞–∫</label>
      <input type="text" id="plates" placeholder="–ê–í9695–ê–í" pattern="^[–ê-–ØA-Z0-9]{8}$" maxlength="8" required />
      <label>–†—ñ–∫ –≤–∏–ø—É—Å–∫—É</label>
      <input type="number" id="year" placeholder="2020" min="1900" max="2099" required />
      <div class="row">
        <div>
          <label>–í–∞–Ω—Ç–∞–∂–Ω—ñ—Å—Ç—å (—Ç)</label>
          <input type="number" step="0.1" min="0" id="capacity" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, 2" required />
        </div>
        <div>
          <label>–û–± º—î–º –∫—É–∑–æ–≤–∞ (–º¬≥)</label>
          <input type="number" step="0.1" min="0" id="volume" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, 12" required />
        </div>
      </div>
      <label>–í–Ω—É—Ç—Ä—ñ—à–Ω—ñ –≥–∞–±–∞—Ä–∏—Ç–∏ –∫—É–∑–æ–≤–∞ (–î√ó–®√ó–í, –º)</label>
      <div class="row">
        <div><input type="number" id="length" placeholder="–î–æ–≤–∂–∏–Ω–∞" step="0.01" min="0" required /></div>
        <div><input type="number" id="width" placeholder="–®–∏—Ä–∏–Ω–∞" step="0.01" min="0" required /></div>
        <div><input type="number" id="height" placeholder="–í–∏—Å–æ—Ç–∞" step="0.01" min="0" required /></div>
      </div>
      <label>–ú—ñ—Å—Ç–æ –±–∞–∑—É–≤–∞–Ω–Ω—è</label>
      <input type="text" id="city" list="city-list" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, –õ—å–≤—ñ–≤" required />
      <datalist id="city-list"></datalist>
      <input type="hidden" id="city_lat" />
      <input type="hidden" id="city_lng" />
      <div class="checkbox-group">
        <label><input type="checkbox" id="lift" /> –ì—ñ–¥—Ä–æ–±–æ—Ä—Ç</label>
        <label><input type="checkbox" id="top_loading" /> –í–µ—Ä—Ö–Ω—î –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</label>
        <label><input type="checkbox" id="side_loading" /> –ë–æ–∫–æ–≤–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</label>
      </div>
    </div>
    <div class="block">
      <h3>üë§ –î–∞–Ω—ñ –ø–µ—Ä–µ–≤—ñ–∑–Ω–∏–∫–∞</h3>
      <label>–ü–Ü–ë –ø–µ—Ä–µ–≤—ñ–∑–Ω–∏–∫–∞</label>
      <input type="text" id="owner_name" placeholder="–ü–µ—Ç—Ä–µ–Ω–∫–æ –Ü–≤–∞–Ω –Ü–≤–∞–Ω–æ–≤–∏—á" required />
      <label>–ü–Ü–ë –≤–æ–¥—ñ—è</label>
      <input type="text" id="driver_name" placeholder="–ü–µ—Ç—Ä–µ–Ω–∫–æ –Ü–≤–∞–Ω" required />
      <label>–§–æ—Ä–º–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó</label>
      <select id="registration_type" onchange="toggleRegistrationFields()" required>
        <option value="">–û–±–µ—Ä—ñ—Ç—å —Ñ–æ—Ä–º—É</option>
        <option value="fop">–§–û–ü</option>
        <option value="llc">–¢–û–í</option>
        <option value="none">–ù–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π</option>
      </select>
      <div id="registrationDetails" style="display: none">
        <label id="regLabel"></label>
        <input type="text" id="reg_name" placeholder="" />
        <label>–ö–æ–¥ –Ñ–î–†–ü–û–£ / –†–ù–û–ö–ü–ü</label>
        <input type="text" id="edrpou" placeholder="8 –∞–±–æ 10 —Ü–∏—Ñ—Ä" pattern="^(\d{8}|\d{10})$" maxlength="10" inputmode="numeric" />
      </div>
      <label>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É</label>
      <input type="tel" id="phone" placeholder="380XXXXXXXXX" required />
      <label>–ö–æ–º–µ–Ω—Ç–∞—Ä</label>
      <textarea id="comment" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è..."></textarea>
    </div>
    <button type="submit">‚úÖ –ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
  </form>
  <script>
    const form = document.getElementById('driverForm');
    const userInfo = Telegram.WebApp.initDataUnsafe?.user || {};
    const registrationDate = new Date().toISOString();

    function toggleRegistrationFields() {
      const type = document.getElementById('registration_type').value;
      const block = document.getElementById('registrationDetails');
      const label = document.getElementById('regLabel');
      const input = document.getElementById('reg_name');
      if (type === 'fop') {
        block.style.display = 'block';
        label.textContent = '–§–û–ü';
        input.placeholder = '–ü—Ä—ñ–∑–≤–∏—â–µ –Ü–º º—è –ü–æ –±–∞—Ç—å–∫–æ–≤—ñ';
      } else if (type === 'llc') {
        block.style.display = 'block';
        label.textContent = '–¢–û–í';
        input.placeholder = '–ù–∞–∑–≤–∞ –∫–æ–º–ø–∞–Ω—ñ—ó';
      } else {
        block.style.display = 'none';
      }
    }

    const cityInput = document.getElementById('city');
    const cityList = document.getElementById('city-list');
    let citySuggestions = [];
    let debounceTimer;

    cityInput.addEventListener('input', function () {
      const query = this.value.trim();
      clearTimeout(debounceTimer);
      if (query.length < 3) {
        cityList.innerHTML = '';
        cityInput.classList.remove('valid');
        return;
      }
      debounceTimer = setTimeout(async () => {
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&accept-language=uk&countrycodes=ua&limit=5&q=${encodeURIComponent(query)}`);
          const data = await res.json();
          cityList.innerHTML = '';
          citySuggestions = [];
          data.forEach(place => {
            const { display_name, address } = place;
            const city = address.city || address.town || address.village || display_name.split(',')[0];
            const region = address.state || address.region || '';
            const fullName = `${city}, ${region}`;
            const option = document.createElement('option');
            option.value = fullName;
            cityList.appendChild(option);
            citySuggestions.push({ name: fullName, city: city, region: region, lat: place.lat, lon: place.lon });
          });
        } catch (error) {
          console.error("OSM error:", error);
        }
      }, 500);
    });

    cityInput.addEventListener('change', function () {
      const match = citySuggestions.find(city => city.name === this.value);
      if (match) {
        document.getElementById('city_lat').value = match.lat;
        document.getElementById('city_lng').value = match.lon;
        cityInput.classList.add('valid');
        cityInput.classList.remove('invalid');
      } else {
        cityInput.classList.remove('valid');
        cityInput.classList.add('invalid');
      }
    });

    form.addEventListener('submit', async function (e) {
      e.preventDefault();
      const data = {
        brand: form.brand.value,
        model: form.model.value,
        plates: form.plates.value,
        year: form.year.value,
        capacity: form.capacity.value,
        volume: form.volume.value,
        length: form.length.value,
        width: form.width.value,
        height: form.height.value,
        city: form.city.value,
        city_lat: document.getElementById('city_lat').value,
        city_lng: document.getElementById('city_lng').value,
        lift: form.lift.checked,
        top_loading: form.top_loading.checked,
        side_loading: form.side_loading.checked,
        owner_name: form.owner_name.value,
        driver_name: form.driver_name.value,
        registration_type: form.registration_type.value,
        reg_name: form.reg_name?.value || '',
        edrpou: form.edrpou?.value || '',
        phone: form.phone.value,
        comment: form.comment.value,
        chat_id: userInfo.id,
        first_name: userInfo.first_name,
        last_name: userInfo.last_name,
        username: userInfo.username,
        registration_date: registrationDate
      };

      try {
        console.log("Sending data:", data);
        await fetch("https://firstbs.app.n8n.cloud/webhook/9202bdb6-cec6-45b0-a0a4-76a17c6cc79c", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        Telegram.WebApp.showPopup({
          message: "‚úÖ –î—è–∫—É—î–º–æ! –î–∞–Ω—ñ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ.",
          buttons: [{ id: "ok", type: "default", text: "–û–ö" }]
        });
        Telegram.WebApp.onEvent("popupClosed", function () {
          Telegram.WebApp.close();
        });
      } catch (err) {
        console.error("Submit error:", err);
        Telegram.WebApp.showPopup({
          message: "‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –ø—ñ–∑–Ω—ñ—à–µ.",
          buttons: [{ id: "close", type: "default", text: "–û–ö" }]
        });
      }
    });
  </script>
</body>
</html>
